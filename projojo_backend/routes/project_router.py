from fastapi import APIRouter, Path, File, UploadFile, Form, HTTPException, Body, Depends
from typing import Annotated, Optional
from datetime import datetime
import traceback

from domain.repositories import ProjectRepository
from domain.models import ProjectCreation
from service import task_service, save_image
from auth.jwt_utils import get_token_payload

project_repo = ProjectRepository()

router = APIRouter(prefix="/projects", tags=["Project Endpoints"])

# Project endpoints
@router.get("/")
async def get_all_projects():
    """
    Get all projects for debugging purposes
    """
    projects = project_repo.get_all()
    return projects

@router.get("/{id}")
async def get_project(id: str = Path(..., description="Project ID")):
    """
    Get a specific project by ID
    """
    project = project_repo.get_by_id(id)
    return project


@router.get("/{id}/complete")
async def get_project_full(id: str = Path(..., description="Project ID")):
    """
    Get a specific project by ID with all tasks and skills
    """
    project = project_repo.get_by_id(id)
    project.tasks = task_service.get_tasks_with_skills_by_project(id)

    project_dict = project.__dict__
    project_dict["business"] = project_repo.get_business_by_project(id)
    return project_dict


@router.get("/{id}/tasks")
async def get_project_tasks(id: str = Path(..., description="Project ID")):
    """
    Get all tasks for a project
    """
    tasks = task_service.get_tasks_with_skills_by_project(id)
    return tasks

@router.post("/", response_model=ProjectCreation, status_code=201)
async def create_project(
    name: Annotated[str, Form(...)],
    description: Annotated[str, Form(...)],
    supervisor_id: Annotated[str, Form(...)],
    business_id: Annotated[str, Form(...)],
    image: UploadFile = File(...)
):
    """
    Create a new project with image upload
    """
    # Validate required fields
    if not image or not image.filename:
        raise HTTPException(
            status_code=400,
            detail="Een projectafbeelding is verplicht."
        )

    if project_repo.check_project_exists(name, business_id):
        raise HTTPException(
            status_code=400,
            detail=f"Project met de naam '{name}' bestaat al binnen dit bedrijf."
        )

    # Save the image with a random filename
    unique_filename = save_image(image)

    # Create project data
    project_creation = ProjectCreation(
        id=None,  # ID will be generated by repository
        name=name,
        description=description,
        image_path=unique_filename,  # Use the unique filename
        created_at=datetime.now(),
        supervisor_id=supervisor_id,
        business_id=business_id
    )

    # Create the project in the database
    created_project = project_repo.create(project_creation)
    return created_project

@router.put("/{id}")
async def update_project(
    id: str = Path(..., description="Project ID to update"),
    name: str = Form(...),
    description: str = Form(...),
    location: str = Form(...),
    image: Optional[UploadFile] = File(None),
    payload: dict = Depends(get_token_payload)
):
    """
    Update project information with optional photo upload.
    Only a teacher or a supervisor of the same business may update the project.
    """
    # Verify project exists (and retrieve its business_id for authorization)
    try:
        existing = project_repo.get_by_id(id)
    except Exception:
        existing = None

    if not existing:
        raise HTTPException(status_code=404, detail="Project niet gevonden")

    # Authorization: teacher or supervisor belonging to the same business
    allowed = (
        payload.get("role") == "teacher" or
        (payload.get("role") == "supervisor" and payload.get("businessId") == existing.business_id)
    )
    if not allowed:
        raise HTTPException(status_code=403, detail="Je bent niet bevoegd om het project bij te werken")

    # Handle photo upload if provided
    image_filename = None
    if image and image.filename:
        try:
            image_filename = save_image(image)
        except Exception as e:
            raise HTTPException(status_code=500, detail="Er is een fout opgetreden bij het opslaan van de afbeelding" + str(e))

    try:
        project_repo.update(id, name, description, location, image_filename)
        return {"message": "Project succesvol bijgewerkt"}
    except Exception as e:
        # Log full traceback to console for debugging
        traceback.print_exc()
        raise HTTPException(status_code=500, detail="Er is een fout opgetreden bij het bijwerken van het project: " + str(e))
