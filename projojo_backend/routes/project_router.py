from fastapi import APIRouter, Path, File, UploadFile, Form, HTTPException, Request
from typing import Annotated
from datetime import datetime
from auth.permissions import auth

from domain.repositories import ProjectRepository
from domain.models import ProjectCreation
from service import task_service, save_image

project_repo = ProjectRepository()

router = APIRouter(prefix="/projects", tags=["Project Endpoints"])

# Project endpoints
@router.get("/")
@auth(role="authenticated")
async def get_all_projects():
    """
    Get all projects for debugging purposes
    """
    projects = project_repo.get_all()
    return projects

@router.get("/archived")
@auth(role="teacher")
async def get_archived_projects():
    """
    Get archived projects (teacher-only)
    """
    return project_repo.get_archived()

@router.get("/{project_id}")
@auth(role="authenticated")
async def get_project(project_id: str = Path(..., description="Project ID")):
    """
    Get a specific project by ID
    """
    project = project_repo.get_by_id(project_id)
    return project


@router.get("/{project_id}/complete")
@auth(role="authenticated")
async def get_project_full(project_id: str = Path(..., description="Project ID")):
    """
    Get a specific project by ID with all tasks and skills
    """
    project = project_repo.get_by_id(project_id)
    project.tasks = task_service.get_tasks_with_skills_by_project(project_id)

    project_dict = project.__dict__
    project_dict["business"] = project_repo.get_business_by_project(project_id)
    return project_dict


@router.get("/{project_id}/tasks")
@auth(role="authenticated")
async def get_project_tasks(project_id: str = Path(..., description="Project ID")):
    """
    Get all tasks for a project
    """
    tasks = task_service.get_tasks_with_skills_by_project(project_id)
    return tasks

@router.post("/", response_model=ProjectCreation, status_code=201)
@auth(role="supervisor", owner_id_key="business_id")
async def create_project(
    name: Annotated[str, Form(...)],
    description: Annotated[str, Form(...)],
    supervisor_id: Annotated[str, Form(...)],
    business_id: Annotated[str, Form(...)],
    image: UploadFile = File(...)
):
    """
    Create a new project with image upload
    """
    # Validate required fields
    if not image or not image.filename:
        raise HTTPException(
            status_code=400,
            detail="Een projectafbeelding is verplicht."
        )

    if project_repo.check_project_exists(name, business_id):
        raise HTTPException(
            status_code=400,
            detail=f"Project met de naam '{name}' bestaat al binnen dit bedrijf."
        )

    # Save the image with a random filename
    unique_filename = save_image(image)

    # Create project data
    project_creation = ProjectCreation(
        id=None,  # ID will be generated by repository
        name=name,
        description=description,
        image_path=unique_filename,  # Use the unique filename
        created_at=datetime.now(),
        supervisor_id=supervisor_id,
        business_id=business_id
    )

    # Create the project in the database
    created_project = project_repo.create(project_creation)
    return created_project


@router.post("/{project_id}/archive")
@auth(role="supervisor", owner_id_key="project_id")
async def archive_project(
    request: Request,
    project_id: str = Path(..., description="Project ID")
):
    """
    Archive a project and cascade to its tasks and registrations.
    Teacher and owning supervisor are allowed.
    """
    try:
        project_repo.archive(project_id, request.state.user_id)
        return {"message": "Project succesvol gearchiveerd"}
    except Exception as e:
        print(f"Error archiving project {project_id}: {e}")
        raise HTTPException(
            status_code=500,
            detail="Er is een fout opgetreden bij het archiveren van het project."
        )

@router.post("/{project_id}/unarchive")
@auth(role="teacher")
async def unarchive_project(
    project_id: str = Path(..., description="Project ID")
):
    """
    Unarchive a project and cascade to its tasks and registrations.
    Teacher-only.
    """
    try:
        project_repo.unarchive(project_id)
        return {"message": "Project succesvol hersteld"}
    except Exception as e:
        print(f"Error unarchiving project {project_id}: {e}")
        raise HTTPException(
            status_code=500,
            detail="Er is een fout opgetreden bij het herstellen van het project."
        )
